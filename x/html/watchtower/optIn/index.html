
<link href="{$REPO}/js/ext-3.2.1/examples/ux/css/Spinner.css" rel="stylesheet" type="text/css"/>
<link href="{$REPO}/js/jq/uploadify/uploadify.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="{$REPO}/js/jq/uploadify/swfobject.js"></script>
<script type="text/javascript" src="{$REPO}/js/ext-3.2.1/examples/ux/DataView-more.js"></script>
<script type="text/javascript" src="{$REPO}/js/ext-3.2.1/examples/ux/Spotlight.js"></script>

<script type="text/javascript" src="{$REPO}/js/jq/uploadify/jquery.uploadify.v2.1.4.min.js"></script>
<script type="text/javascript" src="/{$toBackDoor}/html/{$toBackDoor}/upload/panel.js"></script>
{assign var=htmleditor value="/bin/js/ext/plugins/ExtJS.ux.HtmlEditor.Plugins/"}

<style>
	.drip-email{ z
	}
	
	.postcard{
		 width	: 27%;
		 margin: 2%; 
		 float: left;
display: inline-block;
		 
		 padding	: 5px;
		 border-left: 5px solid green;
		 border-right: 5px solid yellow;
		
		  border-top: 2px solid red;
		background-color	: #fefefe;
		-moz-border-radius: 5px 25px 5px 15px ; 
		-webkit-border-radius: 5px 25px 5px 15px ;
		-moz-box-shadow: 1px 1px 10px rgba(0,0,0,0.25);
		-webkit-box-shadow: 1px 1px 10px rgba(0,0,0,0.25);
		text-shadow: 0 -1px 1px rgba(0,0,0,0.25);
		border-bottom: 5px solid #0095eb;   
		
		overflow: hidden;
	}
	.postcard h1{
		font-size: 20px;
	}
	.post-email{
		position: absolute;
		width	: 27%;   
		/* postit background: rgba( 255,253,215,0.90); */
		background: rgba( 236,253,253,0.90);  
		
		border: 1px solid #c5f1ff;
		border-left: 5px dotted rgba( 236,253,253,0.90); 
		-webkit-box-shadow: 0px 0px 5px rgba(0,0,0,0.25);
		border-top: 0;
		border-bottom: 0;
		padding	: 10px; 
		font-family: courier;
		margin-left: -10px;
		height	: 175px;
		margin-top: -25px;
		margin-bottom: -25px;
		 display: none;
		 -moz-border-radius:5px ; 
		-webkit-border-radius: 5px;
	}
	
	.post-email fieldset{
		border-top: 0px;
		border-bottom: 0px;
		border-color: #dbe9f1; 
		border-size: 2px; 
	
	}
	
	.post-stamp{
		float: right;
		border	: 2px dotted #aaa;
		 padding: 5px;
		 margin: 5px;
		 text-align: center;
		 width: 35px;
		 height: 35px;
		 -webkit-border-radius: 5px;
		 -moz-border-radius: 5px;
	}
	
	.post-subject {
		postion: absolute;
		width	: 55%;
		background-color: #f2faff;
		font-size: 14px;
		padding: 20px;
		margin: 25px 0 20px 15px;
		border-top:1px solid #eeeeee;
		border-right: 1px solid #fefefe; 
		border-bottom: 1px solid #fafa;
		border-left: 1px solid #ddd;
		 -moz-border-radius:10px ; 
		-webkit-border-radius: 10px;
	}
	
	.magnet-wrap {
		display: inline-block;
		margin	: 1%;
		width: 23%;
	}
	.magnet{
		border-bottom: 3px solid rgba(100,100,100,0.15);
		 
		background: red;
		margin: 1%;
		-moz-border-radius: 0 200px 200px 0;
		-webkit-border-radius: 0 200px 200px 0;
		 border-left: 0px;
		border-top: 0px;
		width: 100%; 
		-webkit-box-shadow: 5px 5px 5px rgba(0,0,0,0.25);
		background: rgb(0,27,137); /* Old browsers */
		background: -moz-linear-gradient(top, rgb(0,27,137) 0%, rgb(49,30,255) 50%, rgb(196,1,1) 50%, rgb(255,50,50) 100%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(0,27,137)), color-stop(50%,rgb(49,30,255)), color-stop(50%,rgb(196,1,1)), color-stop(100%,rgb(255,50,50))); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top, rgb(0,27,137) 0%,rgb(49,30,255) 50%,rgb(196,1,1) 50%,rgb(255,50,50) 100%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top, rgb(0,27,137) 0%,rgb(49,30,255) 50%,rgb(196,1,1) 50%,rgb(255,50,50) 100%); /* Opera11.10+ */
		background: -ms-linear-gradient(top, rgb(0,27,137) 0%,rgb(49,30,255) 50%,rgb(196,1,1) 50%,rgb(255,50,50) 100%); /* IE10+ */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#001b89', endColorstr='#ff3232',GradientType=0 ); /* IE6-9 */
		background: linear-gradient(top, rgb(0,27,137) 0%,rgb(49,30,255) 50%,rgb(196,1,1) 50%,rgb(255,50,50) 100%); /* W3C */
	}
	
	.magnet .title{
		color: white;
		text-shadow: 0px 0px 5px rgba(255,255,255,0.25);
		position: absolute;
		margin: 15px 0 0 0;
		margin-left: 7%;
		font-size: 12px;
		font-weight: bold;
		font-family: tahoma;
	}
	
	.magnet .pole{
		width: 20%;
		height: 45px; 
		background: rgb(226,226,226); /* Old browsers */
		border-right: 3px solid #fafafa;
		-webkit-box-shadow: -5px 5px 5px rgba(0,0,0,0.1);
		 
background: rgb(204,204,204); /* Old browsers */
background: -moz-linear-gradient(left, rgb(204,204,204) 0%, rgb(255,255,255) 25%, rgb(239,239,239) 25%, rgb(137,137,137) 100%); /* FF3.6+ */
background: -webkit-gradient(linear, left top, right top, color-stop(0%,rgb(204,204,204)), color-stop(25%,rgb(255,255,255)), color-stop(25%,rgb(239,239,239)), color-stop(100%,rgb(137,137,137))); /* Chrome,Safari4+ */
background: -webkit-linear-gradient(left, rgb(204,204,204) 0%,rgb(255,255,255) 25%,rgb(239,239,239) 25%,rgb(137,137,137) 100%); /* Chrome10+,Safari5.1+ */
background: -o-linear-gradient(left, rgb(204,204,204) 0%,rgb(255,255,255) 25%,rgb(239,239,239) 25%,rgb(137,137,137) 100%); /* Opera11.10+ */
background: -ms-linear-gradient(left, rgb(204,204,204) 0%,rgb(255,255,255) 25%,rgb(239,239,239) 25%,rgb(137,137,137) 100%); /* IE10+ */
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#cccccc', endColorstr='#898989',GradientType=1 ); /* IE6-9 */
background: linear-gradient(left, rgb(204,204,204) 0%,rgb(255,255,255) 25%,rgb(239,239,239) 25%,rgb(137,137,137) 100%); /* W3C */
}
	
	.magnet .whitespace{
		-moz-border-radius: 0 200px 200px 0;
		-webkit-border-radius: 0 200px 200px 0; 
		width: 80%;
		display: block;
		background-color: white;
		border-top: 3px solid rgba(0,0,0,0.25);
		border-right: 3px solid rgba(0,0,0,0.25);
		-webkit-box-shadow: inset -5px 5px 5px rgba(0,0,0,0.25);
	}
	
	.magnet button{
		border	: 0px;
	}
	
	.magnet .south{
	color: white;
	 
		 
	 }
	
</style>

<script type="text/javascript"><!--

	x4.email = {
		openPre : function(e){
			// mouse moved over email - open the note
			if (!e) var e = window.event;
			var relTarg = e.relatedTarget || e.fromElement;
			alert(relTarg.id)
		},
		closePre : function(e){
			// mouse moved out of the email - close the note.
			if (!e) var e = window.event;
			var relTarg = e.relatedTarget || e.toElement;

			alert(relTarg.id)
		},
		
	};

	Ext.onReady(function(){
		x4.direct('xOptIn');
		xMagnet = {
			copyContent 		: function(id,url,fn){
				url = (url) ? url : 'Name_Me';
				url =  prompt('Name Magnet\'s WebSite Location | http://{$HTTP_HOST}/'+url,url);
				if(url){
					$.post('/{$toBackDoor}/{$Xtra}/copyMagnet/?json',{
						id	: id,
						url	: url
					},function(json){
						page_data.getStore().reload();
						if(fn){
							fn(json);
						}
					});

				}
			},			
			openContent 		: function(el,id,url,hidden){
				location.hash  = '#optIn';

				
				if(Ext.getCmp('editor-win')){
					Ext.getCmp('editor-win').close()
				}
	
				if(!hidden){
					Ext.Msg.wait('Please wait...','<img src="{$ICON.16}/magnet_blue.png" align="left"/> Lead Magnet Editor');	
				}
	
				var bullet = 1;
	
				var store_url = "/{$toBackDoor}/{$Xtra}/jsonDrips/"+id+"/";
				var height = $(window).height()*.65;
	
				auto_emails_store = new Ext.data.JsonStore({
			        url		: store_url,
			        method	: 'POST',
			        root	: 'data',
			        idProperty	: 'id',
			        fields	: {$email_fields}
			    });


				var template = new Ext.XTemplate(
						'<tpl for=".">',
						'<div class="drip-email" id="{literal}drip_{id}{/literal}"  >',
						
						'<div class="postcard">',
						'<div class="post-email" id="{literal}drip_email_{id}{/literal}">', 
							'<div style="float: right; border-left: 1px solid rgba(255,0,0,0.25); width: 55px; padding: 15px;">',
								'<button class="punch" style=" " title="Edit" ><img src="{$ICON.32}/new mail.png"/></button></br>',
								'<button class="punch" style="  " title="Copy"><img src="{$ICON.32}/music.png"/></button></br>', 
								'<button class="punch" style=" " title="Delete"><img src="{$ICON.32}/minus.png"/></button>', 
								
							'</div>',
							'<fieldset><legend style="width: 95%; border-bottom: 1px solid rgba(0,0,255,0.25); padding: 10px;">{literal}Day {day_in_chain} | {subject}{/literal}</legend>', 
							'{literal}{email_content}{/literal}</fieldset>',
							
							
						'</div>', 
						
								'<div class="post-stamp"><b>DAY</b><h1 style="font-size: 13px">{literal}{day_in_chain}{/literal}</h1></div>',
								'<div style="float: left">{literal}{from_address}{/literal}</div>',
								  
								 
								'<div class="post-subject">{literal}{subject}{/literal}</div>',
								 
								
								
							'</div>',  
						'</div>',
						'</tpl>'
					);



				/**
				 * Dataview
				 */
				{include 
					file="~extjs/dataview.js" 
					var="auto_emails" 
					template="template"
					root="data"
					url="store_url" 
					fields=$email_fields
					itemSelector = 'div.drip-email'
					store="auto_emails_store"}

				
				 
				auto_emails.addListener('dblclick', function(dv, i, n, e) {
					alert(n.id);
					var rec = auto_emails.getSelectedRecords();
					new_drip_win.show();
			        new_drip_form.getForm().loadRecord(rec);
			    });

				auto_emails_store.addListener('load', function(dv, i, n, e) {
					 
					$("div.postcard").mouseenter(function(){
						$("div.post-email",this).slideDown('fast'); 
				    }).mouseleave(function(){
				      $("div.post-email",this).slideUp('fast');
				    });
			    });
				

				
				/*
				
				
				{include 
					file="~extjs/grid.js" 
					var="auto_emails"
					root="data"
					url="store_url"  
					height="height"
					region="center"
					fields=$email_fields
					columns=$email_columns
					store="auto_emails_store"}
				
				auto_emails.getSelectionModel().addListener('rowselect', function(sm, row, rec) {
			        Ext.getCmp("new-drip-form").getForm().loadRecord(rec);
			    });
	
				auto_emails.addListener('dblclick', function(sm, row, rec) {
					var rec = auto_emails.getSelectionModel().getSelected();
					new_drip_win.show();
			        new_drip_form.getForm().loadRecord(rec);
			    })
				
				*/
	
			    headlines_store = new Ext.data.JsonStore({
			        url		: "/{$toBackDoor}/{$Xtra}/jsonHeadlines/"+id+"/",
			        method	: 'POST',
			        root	: 'data',
			        idProperty	: 'id',
			        fields	: {$headlines_fields}
			    });
			    
			    {include 
					file="~extjs/grid.js" 
					var="headlines"
					height="height"
					region="center"
					columns=$headlines_columns
					store="headlines_store"}
	
			    headlines.getSelectionModel().addListener('rowselect', function(sm, row, rec) {
			        Ext.getCmp("new-headline-form").getForm().loadRecord(rec);
			    });
			    
			    headlines.addListener('dblclick', function(sm, row, rec) {
			    	var rec = Ext.getCmp('headlines-grid').getSelectionModel().getSelected();
					
					var win = Ext.getCmp('new-headline-win');
					
					win.show(null,function(){
						Ext.getCmp("new-headline-form").getForm().loadRecord(rec);
					});
			    });
			        
				iframeurl = url;	
			
				var magUrlPan;
				var winCfg = {		
					title	: 'Lead Magnet Editor | '+ url,
					id		: 'editor-win', 
					iconCls	: 'x-icon-16x16-magnet_pencil',
					maximized: true,
					layout	: 'border',
					border	: false,
					tools	: [{
						id	: 'help',
						handler	: function(){
							Ext.getCmp('help-column').expand();	
						}
					}],
					listeners	: {
						beforeClose	: function(){
							//Ext.getCmp('editor-win').destroy();
						},
						close	: function(){
							//document.getElementById('iframe').src = "about:blank";
							//Ext.getCmp('editor-win').destory(); 
						}
					},
					defaults	: {
						border	: false
					},
					items	: [{
						region	: 'east',
						width	: 250,
						title	: 'Help Column',
						collapsible: true,
						iconCls	: 'x-icon-16x16-pill',
						id		: 'help-column',
						padding	: 5,
						autoScroll: true,
						collapsed: true
					},{
						xtype	: 'form',
						api		: {
							submit	: $$.xOptIn.add,
							load	: $$.xOptIn.edit
						},
						baseParams	: {
							id	: id
						},
						paramOrder	: 'id',
						id		: 'new-form',
						region	: 'center',
						border	: false, 
						frame	: false,
						layout	: 'border',
						defaults	: {
							border	: false,
						},
						items	: [{
							region: 'north',
							buttonAlign	: 'left',
							buttons	: [{
								text	: 'Save As New',
								tooltip	: { title: 'Save as New ', text	: 'Click to Copy Current Data into <b>a New Magnet</b>'},
								iconCls	: 'x-icon-16x16-magnet_plus',
								iconAlign	: 'bottom',
								handler	: function(){
									Ext.Msg.wait('Saving as New','Please wait...');
									// Save as new
									// Copies current magnet
									xMagnet.copyContent(id,url+'_copy',function(json){
										var data = $.parseJSON(json);
										// On return - change form to new id
										
										Ext.getCmp('form-id').setValue(data.id);
	
										Ext.getCmp('form-url').setValue(data.url);
										
										
										// save form as if opened to edit. 
										Ext.getCmp('new-form').getForm().submit({
											//url		: '/{$toBackDoor}/{$Xtra}/add/?returnJson',
											success	: function(){
												Ext.Msg.hide();
												page_data.getStore().load(null,function(){
													if(page_data.getStore().data.length < 1){
														window.location = "{$ME}";
													}
									            });
						
												// Ask to Close. 
									            var ask = confirm(data.url+' ~ Saved! Click OK to Close Edit Window');
									            if(ask){
									            	Ext.getCmp('editor-win').close();
										        }
											},
											failure : function(f,a){
												Ext.Msg.alert('Failed!',a.result.error);
											}
										});
										
									});
									 
								}
							},'-',{
								text	: 'Save & Close',
								iconAlign	: 'bottom',
								tooltip	: { title : 'Save & Close', text: 'Click to Save and <b>Close the Lead Magnet Editor</b>'},
								iconCls	: 'x-icon-16x16-magnet_blue',
								handler	: function(){
									Ext.Msg.wait('Saving','Please wait...');
									Ext.getCmp('new-form').getForm().submit({
										//url		: '/{$toBackDoor}/{$Xtra}/add/?returnJson',
										success	: function(){
											Ext.Msg.hide();
											page_data.getStore().load(null,function(){
												if(page_data.getStore().data.length < 1){
													window.location = "{$ME}";
												}
								            });
									
											Ext.getCmp('editor-win').close();
											Ext.Msg.alert('Success!',url+' Saved');
											
										},
										failure : function(f,a){
											Ext.Msg.alert('Failed!',a.result.error);
										}
									});
								}
							},'-',{
								text	: 'Save & View',
								tooltip	: { title : 'Save & View', text: 'Click to Save and <b>Preview the Lead Magnet</b>'},
								iconAlign	: 'bottom',
								iconCls	: 'x-icon-16x16-magnet_arrow',
								handler	: xMagnet.applyMagnet
							},'->',{
								text		: 'Cancel Editing',
								tooltip	: { title : 'Cancel Editing', text: 'Click to Cancel Editor, <b>Loosing any Changes Made</b>'},
								iconAlign	: 'bottom',
								iconCls		: 'x-icon-16x16-magnet_exclamation',
								handler		: function(){
									Ext.Msg.show({
										title 	: 'Cancel Editing Magnet?',
									   	msg	 	: '<b>'+url+'</b><hr/>You Will Loose Any Changes You Have Made!',
									   	width	: 340,
	
									   	buttons: Ext.Msg.YESNO,
									   	fn: function(btn){
											if(btn == 'yes'){
										   		win.close();
										   	}
										}, 
									   icon: Ext.MessageBox.WARNING
									});
								}
							},'-',{
								text	: 'Delete Magnet',
								tooltip	: { title : 'Delete Magnet', text: 'Click to Permanently Delete <b>this Lead Magnet</b>'},
								iconAlign	: 'bottom',
								iconCls	: 'x-icon-16x16-magnet_minus',
								handler	: function(){
									xMagnet.deleteMagnet(Ext.getCmp('form-id').getValue(),Ext.getCmp('form-url').getValue());
								}
							}],
							layout	: 'form',
							autoHeight	: true
						},magUrlPan = new Ext.Panel({
							layout	: 'column',
							region	: 'south',
							iconCls	: 'x-icon-16x16-world_link',
							title	: '<a href="http://{$HTTP_HOST}/'+url+'" target="_BLANK">http://{$HTTP_HOST}/<b><u>'+url+'</u></b></a>',
							frame	: true,
							autoHeight	: true,
							labelAlign	: 'top',
							defaults	: {
								layout	: 'form'
							},
							items	: [{
								columnWidth	: 1,
								layout	: 'form',
								labelAlign: 'left',
								labelWidth: 100,
								items	: [{
									xtype		: 'hidden',
									id			: 'form-id',
									name		: 'id'
								},{
									xtype		: 'hidden',
									id			: 'form-hidden-theme',
									name		: 'theme'
								},{
									fieldLabel	: 'Magnet Location',
									anchor		: '-10',
									xtype		: 'textfield',
									emptyText	: 'index (For Front Page)',
									name		: 'url',
									id			: 'form-url',
									allowBlank	: false,
									enableKeyEvents: true,
									selectOnFocus	: true,
									listeners	: {
										keyup : function(tf,e){
											if(e.getKey() != 13){ 
												// ENTER
												var clean = tf.getValue().replace(/ /i,'+');
												var tmp = '<a href="http://{$HTTP_HOST}/'+clean+'" target="_BLANK">http://{$HTTP_HOST}/<b><u>'+clean+'</u></b></a>';
												magUrlPan.setTitle(tmp);
												tf.setValue(clean); 										
											}
										}
									}
								}]
							},{
								columnWidth	: .01,
								layout	: 'form',
								items	: [{
									xtype	: 'hidden',
									fieldLabel: 'Name Magnet - 255 Chars. MAX',
									anchor		: '-10',
									name		: 'program_title'
								}]
							}]
						}),{
							xtype		: 'tabpanel',
							plain		: true,
							mintabWidth	:  100,
							resizeTabs	: true,
							enableTabScroll : true,
							id			: 'tabs',
							region		: 'center',
							activeTab	: 0,
							listeners	: {
								tabchange	: function(tp,tab){
									var bd = Ext.getCmp('help-column').body;
			    					bd.update('').setStyle('background','#fff');
			   						detailEl = bd.createChild(); //create default empty div
						    		//detailEl.hide().update(Ext.getDom(tab.getId()+'-details').innerHTML).slideIn('l', { stopFx:true,duration: .5 });
								}
							},
							deferredRender : false,
							style		: 'overflow-y: auto',
							defaults	: {
								border	: false,
								layout	: 'form',
								frame	: true,
								autoScroll: true 
							},
							items	: [{
								title	: '<b>1.</b> Headlines',
								tabTip	: 'Manage Magnetic Headlines',
								id		: 'headlines-tab',
								iconCls : 'x-icon-16x16-tag_blue',
								layout	: 'border',
								forceLayout: true,
								autoScroll: false,
								items	: [{
									region	: 'center',
									layout	: 'fit',
									items	: [headlines],
									frame	: true,
									buttonAlign	: 'center',
									buttons	: [{
										text	: '<b>Add New Headline</b>',
										iconAlign	: 'bottom',
										iconCls	: 'x-icon-16x16-tag_add',
										handler	: function(){
											Ext.getCmp('new-headline-form').getForm().reset();
											xMagnet.showNewHeadlineWin();
										}
									}],	
								},{
									title	: 'Search Engine Optimization',
									collapsed: true,
									frame	: true,
									collapsible: true,
									region	: 'south',
									autoHeight: true,
									autoScroll: true,
									iconCls	: 'x-icon-16x16-magnifier',
									id		: 'seo',
									defaultType	: 'textarea',
									defaults	: {
										anchor	: '97%' 
									},
									layout		: 'form',
									labelAlign	: 'top',
									items	: [{
										fieldLabel	: 'Browser Bar Title (Max 255) | Leave Blank to use A Random Headline',
										xtype		: 'textfield',
										blankText	: 'If left blank, the Highest Rated Headline will be used as the Page Title.',
										name		: 'seo_page_title'
									},{
										fieldLabel	: 'Keywords (Max 2000)',
										blankText	: 'Remember to separate keywords and keyword-phrases by commas. "Item1, Item2, Item Three," etc.',
										name		: 'seo_keywords'
									},{
										fieldLabel: 'Description (Max 1000)',
										name		: 'seo_desc'
									}]
								}]
							},{
								title	: '<b>2.</b> Copy',
								id		: 'magnet-copy',
								iconCls	: 'x-icon-16x16-page',
								layout	: 'border',
								frame	: false,
								defferedRender: false,
								autoScroll	: false,
								items	: [{
									iconCls		: 'x-icon-16x16-application_form',
									region		: 'east',
									
									border		: false,
									width		: 425,						
									xtype		: 'tabpanel',
									plain		: true,
									resizeTabs	: true,
									mintabWidth	:  100,
									deferredRender : false,
									activeTab	: 1,
									collapsible	: true,
									collapseMode: 'mini',
									hideCollapseTool: true,
									split: true,
									defaults	: {
										border	: false,
										autoScroll	: true,
									},
									tabPosition	: 'top',
									listeners	: {
										
									},
									items	: [new x4.iSpace({
										title	: 'X. Upload Files',
										id		: 'updlod',
										iconCls	: 'x-icon-16x16-upload',
										
									}),{
										//xtype		: 'fieldset',
										layout		: 'form',
										frame		: true,
										labelAlign	: 'top',
										title		: 'Y. Opt-In Form', 
										id		: 'optin-tab', 
										iconCls	: 'x-icon-16x16-application_form',
										defferedRender: false,
										defaults	: {
											anchor	: '-18px'
										},
										items		: [{
											fieldLabel	: 'Opt-In Message',
											xtype	: 'tinymce',
											height		: $(window).height()*.30,
											enableFont	: false,
											name		: 'optin_msg',

											anchor: "-20 -50",
											tinymceSettings: {
												 theme: "advanced",
											}
										},{
											xtype	: 'fieldset',
											iconCls	: 'x-icon-16x16-textfield_key',
											title: 'Required Fields',
											items	: [{
											    xtype: 'checkboxgroup',
											    itemCls: 'x-check-group-alt',
											    hideLabel	: true,
											    // Put all controls in a single column with width 100%
											    columns: 3,
											    items: [
											        {
												        boxLabel	: 'Email Address',
												        iconCls		: 'x-icon-16x16-email',
												        name		: 'email',
												        inputValue	: 'on',  
												    },{ 
													    boxLabel	: 'First Name',
													    name		: 'name',
												        inputValue	: 'on',
														//checked		: true
													},{ 
													    boxLabel	: 'Last Name',
												        inputValue	: 'on',
													    name		: 'name_last' 
													},{
														boxLabel	: 'Phone #',  	
														name		: 'phone',
												        inputValue	: 'on'
													},{
														boxLabel	: 'Username',  	
														name		: 'username',
												        inputValue	: 'on'
													},{
														boxLabel	: 'Password',  	
														name		: 'password',
													    inputValue	: 'on'
													}
											    ]
											}]
										},{
											xtype		: 'fieldset',
											defaultType	: 'textfield',
											title		: 'Submit Button',
											iconCls		: 'x-icon-16x16-mouse',
											defaults	: {
												anchor	: '-10'
											},
											items	: [{
												hideLabel 	: true,
												fieldLabel	: 'Submit Button Text',
												name		: 'submit_txt', 
												xtype		: 'textfield'
											},{
												xtype		: 'fieldset',
												checkboxToggle : true,
												checkboxName	: 'paypal_on',
												inputValue	: 'on',
												collapsed	: true,
												iconCls		: 'x-icon-16x16-creditcards',
												title		: 'PayPal Button (*Optional)',
												layout		: 'column',
												defaults	: {
													layout		: 'form',
													defaultType	: 'textfield',
												},
												items		: [{
													columnWidth	: .15,
													items	: [{
														fieldLabel	: 'Price',
														xtype		: 'numberfield',
														name		: 'paypal_price',
														anchor		: '-5px'
													}]
												},{
													columnWidth	: .65,
													items	: [{
														fieldLabel	: 'Item on Receipt',
														name	: 'paypal_item',
														anchor	: '-10'
													}]
												},{
													columnWidth	: .2, 
													layout	: {
				                                        type	: 'vbox',
				                                        padding	:	2,
				                                        align	: 'stretch'
				                                    },
													items	: [{
														xtype	: 'button', 
														text	: 'Set Email',
														flex	: 1,
														iconAlign: 'top',
														iconCls	: 'x-icon-16x16-email',
														handler	: function(){
															x4.loadZyx('treasurer/paypal');
														}
													}]
	
												}]
											}]
										},{
											fieldLabel	: 'Privacy Policy',
											xtype	: 'textarea',
											name		: 'privacy',
											defaultValue: 'We will not rent, trade, or release your information to any third party for any reason - ever. We respect YOUR email privacy and dislike spam as much as you do.'
										}]
									},{
										title	: 'Z. Thank You', 
	
										id		: 'thank-you-tab',
										iconCls	: 'x-icon-16x16-thumb_up',
										//xtype	: 'form',
										layout	: 'form',
										frame	: true,
										defaults	: {
											anchor	: '95%'
										},
										items	: [{
											xtype	: 'fieldset', 
											title	: 'Redirect to Web Page - Start links outside this site with: http://',
											iconCls	: 'x-icon-16x16-world_link',
											layout	: 'column',
											defaults	: {
												layout	: 'form',
												labelAlign	: 'top'	
											},
											items	: [{
												columnWidth	: .75,
												items	: [{
													xtype	: 'textfield',
												 	fieldLabel : 'Leave Blank to Not Redirect',
													blankText	: 'Enter Full URL - http://... etc',
													blankText	: 'http://',
													name		: 'thank_you_url',
													anchor	: '95%' 
												}]
											},{
												columnWidth	: .25,
												items	: [{
													fieldLabel	: 'Redirect Countdown',
													xtype	: 'spinnerfield',
													name	: 'thank_you_timeout', 
													minValue: 0,
													value	: 5,
													defaultValue	: 5,
													anchor	: '-10',
											    	maxValue: 3650 
												}]
	
											}]
										},{
											title 	: 'Thank You Page',
											xtype	: 'fieldset',
											layout	: 'form',
											iconCls	: 'x-icon-16x16-thumb_up',								
											items	: [{
												xtype	: 'textfield',
												fieldLabel	: 'Headline',
												blankText	: 'Thank You For Visiting!',
												anchor		: '-10',
												name		: 'thank_you_headline' 
											},{
												xtype		: 'tinymce', 
												hideLabel	: true,
												blankText	: 'Thank You [NAME]!',
												height		:  $(window).height()*.50,
												name		: 'thank_you',

												anchor: "-20 -50",
												tinymceSettings: {
													 theme: "advanced",
												}
											}]
										}]
									}]
								},{
									xtype		: 'tabpanel',
									plain		: true,
									resizeTabs	: true,
									mintabWidth	:  100,
									region		: 'center',
									labelAlign	: 'top',
									activeTab	: 0,
									width		: 550,
									defaults	: {
										frame		: true,
										border		: false,
									},
									border		: false,
									tabPosition	: 'top',
									deferredRender : true, 
									items	: [{
										title		: 'A. Attach',
										iconCls		: 'x-icon-16x16-television',
										labelAlign	: 'top',
										layout		: 'accordion',
										id			: 'attach-tab',
										frame		: false,
										defaults	: {
											layout		: 'form',
											frame		: true,
											autoScroll	: true,
											defaults	: {
												anchor	: '-20'
											}
										},
										items		: [{
											height	: 150,
											title	: 'Attract Attention using Audio, Video, an Image...',
											iconCls	: 'x-icon-16x16-movie_play',
											items	: [{
												defaults: {
													layout	: 'form',
												},
												xtype	: 'fieldset',
												title	: 'Link to File or YouTube Address',
												iconCls	: 'x-icon-16x16-link',
												items	: [{
													items	: [{
														hideLabel: true,
														xtype	: 'textfield',
														anchor	: '-10',
														name		: 'video'
													}]
												},{
													xtype	: 'fieldset',
													title	: 'Options',
													//checkboxToggle	: true,
													//collapsed: true,
													items	: [{
														layout	: 'column',
														defaults: {
															layout		: 'form',
															labelAlign	: 'top',
															defaultType	: 'textfield' 
														},
														items	: [{
															columnWidth	: .2,
															items	: [{
																anchor	: '90%',
																fieldLabel	: 'Embed Type',
																xtype	: 'combo',
																readOnly: true, 
																typeAhead: true,
															    triggerAction: 'all',
															    lazyRender:true,
															    mode: 'local',
															    name: 'embed_type',
															    id: 'embed-type',
															    emptyText: 'auto',
															    listeners: {
													    			select: function(cb,r,i){
																		
													    			}
													    		},
															    store: new Ext.data.ArrayStore({ 
															        fields: [
																		'id',
															            'type'
															        ],
															        data: [
																		['image','.png, .jpg, .gif'],
																        ['audio','.aac, .mp3'],
																        ['video','.flv, .mp4'],
																        ['youtube','YouTube']
																	]
															    }),
															    valueField: 'id',
															    displayField: 'type'
															}]
														},{
															columnWidth: .2,
															items	: [{
																anchor		: '-10',
																fieldLabel	: 'Width (px|%)',
																name		: 'video_width',
																value		: '-10'
															}]
														},{
															columnWidth: .2,
															items	: [{
																anchor		: '-10',
																fieldLabel	: 'Height (px)',
																name		: 'video_height',
																value		: '400px'
															}]
														},{
															columnWidth	: .2,
															items	: [{
															    xtype: 'radiogroup',
															    fieldLabel: 'Auto Start',
															    name: 'video_autostart', 
															    items	: [{
														        	boxLabel: 'On',
														        	name: 'video_autostart',
														        	inputValue	: 'true'
															    },{
															        boxLabel: 'Off',
															        inputValue	: 'false', 
															        name: 'video_autostart'
															   }]
															}]
														},{
															columnWidth	: .2,
														    items	: [{
														    	xtype: 'radiogroup',
															    itemCls: 'x-check-group-alt',
															    fieldLabel: 'Player Controls',
															    // Put all controls in a single column with width 100% 
															    name	: 'video_display_controls',
															    items: [{
														        	boxLabel: 'On',
														            name	: 'video_display_controls',
														        	inputValue	: 'true' 
															    },{
															        boxLabel: 'Off',
															        inputValue	: 'false', 
															        name	: 'video_display_controls'
															   }]
															}]
														}]
													}]
												}],
	
											}]
										},{
											height	: 150,
											title	: '... or Custom HTML Code',
											iconCls	: 'x-icon-16x16-html',
											items	: [{
												hideLabel	: true,
												xtype	: 'textarea',
												height	: $(window).height()*.6,
												name	: 'html_code'
											}]
										}]
									},{
										title		: 'B. Bullets',
										id			: 'bullets-tab',
										frame		: true,
										labelAlign	: 'left',
										iconCls		: 'x-icon-16x16-bullet_star',
										layout		: 'form',
										autoScroll	: true,
										defaultType	: 'textfield',  
										labelWidth	: 25,
										labelSeperator : '',
										defaults	: {
											anchor		: '-20',

											labelSeperator : '',
											fieldLabel	: '<img src="{$ICON.16}/bullet_star.png"/>'
												
										},
										items	: [{ 
											hideLabel	: true,
											xtype		: 'textarea',
											height		: 100,
											name		: 'bullet_caption'
										},{
											name		: 'bullet_'+ bullet++ +''
											
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{
											name		: 'bullet_'+ bullet++ +''
										},{  
											xtype	: 'fieldset',
											hideLabel: true,
											title	: 'Bullet Options',
											iconCls	: 'x-icon-16x16-bullet_wrench',
											layout	: 'form', 
											labelAlign: 'top',
											items	: [{
												xtype		: 'textfield',
												name		: 'bullet_image',
												anchor		: '-10',
												fieldLabel	: 'Custom Bullet Image URL'
											},{
											    xtype: 'radiogroup',
											    fieldLabel: 'Alignment',
											    name: 'bullet_align',
											    columns: 3,
											    items	: [{
										        	boxLabel: 'Left',
										        	name: 'bullet_align',
										        	inputValue	: 'left'
											    },{
											        boxLabel: 'Center',
											        inputValue	: 'center', 
											        name: 'bullet_align',
										        	checked: true 
											   },{
											        boxLabel: 'Right',
											        inputValue	: 'right', 
											        name: 'bullet_align',
										        	checked: true 
											   }]
											},
											{
												layout	: 'column',
												items	:[{
													columnWidth	: .30,
													layout		: 'form',
													labelAlign	: 'top',
													items	: [{
														xtype		: 'combo', 
													    fieldLabel	: 'Position',
														typeAhead	: true,
													    width		: 75, 
													    triggerAction: 'all',
													    lazyRender:true,
													    mode: 'local',
													    name: 'bullet_style_position',
													    id: 'bullet-style-position',
													    emptyText: 'outside',
													    listeners: {
											    			select: function(cb,r,i){
																
											    			}
											    		},
													    store: new Ext.data.ArrayStore({ 
													        fields: [
																'id',
													            'type'
													        ],
													        data: [
															        ['Outside','Outside'],
															        ['inside','Inside']
															]
													    }),
													    valueField: 'id',
													    displayField: 'type'
													}]
												},{
													columnWidth	: .70,
													layout		: 'form',
													labelAlign	: 'top',
													items	: [{
														xtype	: 'combo', 
													    fieldLabel: 'Type',
														typeAhead: true,
													    anchor	: '97%',
													    triggerAction: 'all',
													    lazyRender:true,
													    mode: 'local',
													    name: 'bullet_style_type',
													    id: 'bullet-style',
													    emptyText: 'inherit',
													    listeners: {
											    			select: function(cb,r,i){
																
											    			}
											    		},
													    store: new Ext.data.ArrayStore({ 
													        fields: [
																'id',
													            'type'
													        ],
													        data: [
														        ['none','none'],
														        ['circle','circle'],
														        ['disc','disc'],
														        ['square','square'],
														        ['armenian','armenian'],
														        ['decimal','decimal'],
														        ['decimal-leading-zero','decimal-leading-zero'],
														        ['georgian','georgian'],
														        ['lower-alpha','lower-alpha'],
														        ['lower-greek','lower-greek'],
														        ['lower-latin','lower-latin'],
														        ['lower-roman','lower-roman'],
														        ['upper-alpha','upper-alpha'],
														        ['upper-latin','upper-latin'],
														        ['upper-roman','upper-roman']
															]
													    }),
													    valueField: 'id',
													    displayField: 'type'
													}]
												}]
											}]
										}]
									},{
										title		: 'C. Copy',
										id			: 'content-tab',
										autoScroll	: false,
										border		: false,
										frame		: false,
										layout		: 'border',
										iconCls		: 'x-icon-16x16-page_edit',
										
										items		: [/*{
											title		: 'Attention Arrow Text',
											region		: 'south',
											items		: [{
												name		: 'arrow_txt', 
												xtype		: 'tinymce'
											}],
											height		: 100,
										},*/{
											region		: 'center',
											layout		: 'fit',
											border		: false,
											items	: [{
												xtype		: 'tinymce',
												layout		: 'fit',
												border		: false,
												name		: 'content',
												anchor: "100% -50",
												tinymceSettings: {
												 	theme: "advanced",
													script_url : '/bin/js/jq/tiny_mce/tiny_mce.js',
							                       

							                        plugins: "pagebreak,style,layer,table,advhr,advimage,advlink,emotions,iespell,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,noneditable,visualchars,nonbreaking,xhtmlxtras,template",

							                        theme_advanced_buttons1: "newdocument,template,fullscreen,|,undo,redo,|,search,replace,|,cut,copy,paste,pastetext,pasteword,|,inserttime,insertdate,|,preview,print",
							                        
							                        theme_advanced_buttons2: "image,media,anchor,|,link,unlink,|,advhr,hr,|,bullist,numlist,|,outdent,indent,blockquote,sub,sup,|,attribs,code,|,cleanup,iespell",
							                        

							                        theme_advanced_buttons3: "charmap,pagebreak,nonbreaking,|,visualchars,visualaid,|,tablecontrols,|,insertlayer,moveforward,movebackward,absolute",
							                        
							                        theme_advanced_buttons4: "removeformat,styleprops,formatselect,fontselect,fontsizeselect,forecolor,backcolor,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,ltr,rtl",
							                        

							                        theme_advanced_toolbar_location: "top",

							                        theme_advanced_toolbar_align: "left",

							                        theme_advanced_statusbar_location: "bottom",

							                        extended_valid_elements: "a[name|href|target|title|onclick],img[class|src|border=0|alt|title|hspace|vspace|width|height|align|onmouseover|onmouseout|name],hr[class|width|size|noshade],font[face|size|color|style],span[class|align|style]",

							                        //template_external_list_url: "example_template_list.js",

							                        accessibility_focus: false



							                    }
											}]
										}]
									}]
								}]
							},{
								title	: '<b>3.</b> Email Drips',
								id		: 'auto-drip',
								iconCls	: 'x-icon-16x16-email_link',
								frame	: false,
								layout	: 'border',
								
								items	: [{
									region	: 'south',
									collapsible: true,
									layout	: 'form',
									labelAlign: 'top',
									frame	: false,
									height		: 100,
									iconCls	: 'x-icon-16x16-pencil',
									title	: 'The following Below is used to Sign All Emails Sent',
									items	: [{
										 xtype		: 'htmleditor', 
										layout		: 'fit',
										name		: 'email_signature',
										hideLabel	: true,
										anchor: "-0 -10",
										tinymceSettings: {
											 theme: "advanced",
										}
									}]
	
								},{
									region	: 'center', 
									layout	: 'fit',
									tbar	: [{ 
										text: 'Add New Email',
										iconAlign: 'top', 
										iconCls: 'x-icon-16x16-email_add',
										scope: this,
										handler: function(){
											Ext.getCmp('new-drip-form').getForm().reset();
											Ext.getCmp('new-drip-win').show();
											
											var optin_id = Ext.getCmp('form-id').getValue();
											Ext.getCmp('drip-optin-id').setValue(id);
											Ext.getCmp('drip-id').setValue('');
										}
									}, /*
									{
									///xtype	: 'button',
									text	: 'Delete Email',
									iconAlign: 'top',
									iconCls	: 'x-icon-16x16-email_delete',
									handler	: function(){
										//Ext.getCmp('drip-optin-id').setValue(Ext.getCmp('form-id').getValue());
										Ext.Msg.wait('Deleting');
										Ext.getCmp('new-drip-form').getForm().submit({
											url	: '/{$toBackDoor}/{$Xtra}/deleteDrip/?returnJson',
											success	: function(){
												Ext.Msg.hide();
												auto_emails_store.load();
												Ext.getCmp('new-drip-form').getForm().reset();
											},
											failure	: function(){
												Ext.Msg.hide();
											}
										});
									}

								}
									*/], 
									items	: [auto_emails]
								}]
							},{
								title	: 'Done!',
								id		: 'live-view',
								iconCls	: 'x-icon-16x16-eye',
								layout	: 'border',
								padding	: 0,
								frame	: false,
								tbar	: [{
									text	: 'Refresh',
									iconCls	: 'x-icon-16x16-refresh',
									handler	: function(){
										var src 	= Ext.getCmp('form-url').getValue();
										src = (src == 'index') ? 'index/index' : src;
										costume 	= Ext.getCmp('form-hidden-theme').getValue();
										document.getElementById('preview').src = '/'+src+'?theme='+costume;
									}
								},'->','Pick A Look',new Ext.form.ComboBox({  
								    fieldLabel: 'Theme',
								    id	: 'choose-themes',  
								    store: getThemesStore,  
								    valueField: 'id',  
								    displayField: 'name',
								    submitValue	: false,
								    //hiddenName: 'active_id',  
								    mode: 'remote',  
								    minChars : 0 ,
									width:125,
									//name	: 'theme',
									//hiddenName	: 'theme',
									listeners: {
										select: function(cb,r,i){
											var src 	= Ext.getCmp('form-url').getValue();
											src = (src == 'index') ? 'index/index' : src;
											
											costume 	= Ext.getCmp('choose-themes').getValue();
											Ext.getCmp('form-hidden-theme').setValue(costume);
	
											var iframe = document.getElementById('iframe');
											if(iframe){
												iframe.src = '/'+src+'?video_autoplay=off&theme='+costume;
											}
											var preview = document.getElementById('preview');
											if(preview){
												preview.src = '/'+src+'?theme='+costume;
											}
										}
									}
								})],
								items: [new Ext.ux.IFrameComponent({
									region	: 'center',
									width	: '100%',
									height	: '100%',
									id		: 'preview',
									iconCls	: 'x-icon-mouse',
									style	: 'background-color: white',
									url	: '/'+url
								})]
	
							}]
						}],
						//buttonAlign		: 'center',
					}],
					
				};
	
				var win = x4.Window(winCfg);
				
				win.show(el,function(){
					try{
						Ext.Msg.hide();	
						//Ext.getCmp('new-form').getForm().reset();
						//Ext.getCmp('tabs').activate(0); 
						if(id){
							Ext.Msg.wait('Please wait...','<img src="{$ICON.16}/magnet_pencil.png" align="left"/> '+url);
							Ext.getCmp('new-form').getForm().load({ 
								//url		: '/{$toBackDoor}/{$Xtra}/edit/'+id+'/?returnJson',
								failure: function(form, action) {
							        Ext.Msg.alert("Load failed", action.result.errorMessage);
							    },
								success	: function(f,a){
							    	Ext.Msg.hide();	
							    	//renderTiny();
							    	
							    	auto_emails_store.load({
										url	: '/{$toBackDoor}/{$Xtra}/jsonDrips/'+Ext.getCmp('form-id').getValue()
									});
							    	headlines_store.load({
										url	: '/{$toBackDoor}/{$Xtra}/jsonHeadlines/'+Ext.getCmp('form-id').getValue()
									});
									
									var theme = Ext.getCmp('form-hidden-theme').getValue();
									Ext.getCmp('choose-themes').setValue(theme);
									if(document.getElementById('iframe')){
										document.getElementById('iframe').src = '/'+Ext.getCmp('form-url').getValue();
									}
								}
							});
						}
					}catch(e){
						alert(e);
					}

					
				});
			},	
			newMagnetWin		: function(){
				var newForm = x4.Window({ 
					title	: 'http://{$HTTP_HOST}/<b><u>name+here</u></b>',
					iconCls	: 'x-icon-16x16-magnet_plus',
					modal	: true,
					width	: 500,
					autoHeight: true,
					id		: 'magnet-new-win',
					items	: [{
						xtype	: 'form',
						api		: {
							submit	: $$.xOptIn.add
						},
						id		: 'new-program-form',
						layout	: 'form',
						frame	: true,
						iconCls	: 'x-icon-16x16-page_key',
						defaultType	: 'textfield', 
						defaults	: {
							anchor	: '-30px'
						},
						items	: [{
							fieldLabel	: 'Magnet Location',
							name		: 'url',
							id			: '{$ME}-new-magnet-url',
							blankText	: 'index',
							enableKeyEvents: true,
							listeners	: {
								keyup : function(tf,e){
									if(e.getKey() != 13){
										var tmp = 'http://{$HTTP_HOST}/<b><u>';
										var clean = tf.getValue().replace(/ /i,'+');
										Ext.getCmp('magnet-new-win').setTitle(tmp+clean+'</u></b>');
										tf.setValue(clean); 										
									}else{
										xMagnet.createMagnet(newForm);
									}
								}
							}
						}],
						buttonAlign	: 'center',
						buttons	: [{
							text	: 'Create Magnet',
							iconAlign: 'top',
							iconCls	: 'x-icon-16x16-magnet_arrow',
							handler	: function(){
								xMagnet.createMagnet(newForm);
							}
						}]
					}],
					listeners	: {
						show	: function(){
							Ext.getCmp('form-url').focus();
						}
					}
				});
				return newForm;
			},
			createMagnet		: function(newForm){
				Ext.Msg.wait('Creating Magnet','Please Wait...');	
				Ext.getCmp('new-program-form').getForm().submit({
					//url		: '/{$toBackDoor}/{$Xtra}/add/?returnJson',
					success	: function(f,a){
						newForm.close();
						Ext.Msg.hide();
						xMagnet.openContent(null,a.result.POST.id,a.result.POST.url);
						page_data.getStore().load();
					},
					failure : function(){
						Ext.Msg.hide();
					}
				});
			},
			deleteMagnet		: function(id,url){
				Ext.Msg.show({
					msg 	: 'Delete Magnet:<br/><b>'+url+'</b>',
				   	title	: 'Are You Sure? This Can NOT be Undone!',
				   	buttons: Ext.Msg.YESNOCANCEL,
				   	width	: 325,
				   	fn: function(btn){
						if(btn == 'yes'){
					   		Ext.Msg.wait('Please Wait...','Deleting');
					   		$.post('/{$toBackDoor}/{$Xtra}/delete/'+id, function(data) {
						   		Ext.Msg.hide();
					   			page_data.getStore().load();
					   			try{
					   				Ext.getCmp('editor-win').close();
						   		}catch(e){
						   		}
							});
					   	}
					}, 
				   icon: Ext.MessageBox.ERROR
				});
			},
				
			showNewHeadlineWin	: function(){
				x4.Window(new_headline_win);
				win.show(null,function(){
					setTimeout(function(){
						Ext.getCmp('new-headline-text').focus();
					},1000);
				});
			},

			applyMagnet : function (){
				Ext.Msg.wait('Saving','Please wait...');
				Ext.getCmp('new-form').getForm().submit({
					url		: '/{$toBackDoor}/{$Xtra}/add/?returnJson',
					success	: function(){
						Ext.Msg.hide();
						page_data.getStore().load();
						if(!Ext.getCmp('form-id').getValue()){
							window.location = '{$ME}';
						}else{
							Ext.getCmp('tabs').activate('live-view');
							var src 	= Ext.getCmp('form-url').getValue();
							src = (src == 'index') ? 'index/index' : src;
							document.getElementById('preview').src = 'http://{$HTTP_HOST}/'+src+'?theme='+Ext.getCmp('choose-themes').getValue();
							document.getElementById('iframe').src = 'http://{$HTTP_HOST}/'+src+'?video_autoplay=off&theme='+Ext.getCmp('choose-themes').getValue();
						}
					},
					failure : function(f,a){
						Ext.Msg.alert('Failed!',a.result.error);
					}
				});
			},

			allHeadlines	: function(el){ 
			    {include 
					file="~extjs/grid.js" 
					var="allheadlines"
					region="center" 
					columns=$headlines_columns
					store="headlines_store"}

			    allheadlines.addListener('dblclick', function(sm, row, rec) {
			    	var rec = Ext.getCmp('allheadlines-grid').getSelectionModel().getSelected();
			    	Ext.getCmp("new-headline-form").getForm().loadRecord(rec);
					xMagnet.showNewHeadlineWin();
			    });
			    
				x4.Window({
					title	: 'All Headlines',
					id		: 'magnet-all-headlines',
					iconCls	: 'x-icon-16x16-tag_blue',
					maximized: true,
					layout	: 'fit',
					items	: [allheadlines]
				}).show(el,function(){
					headlines_store.load();
				});

			}
		};

var cssElement = 'html';
var costume = '{$www_costume}';

function removeArticle(id,url){
	var q = confirm('Are You sure you want to delete: '+url+'?');
	if(q){
		window.location = "/{$toBackDoor}/{$Xtra}/delete/"+id;
	}
}

function saveAs(){
	Ext.Msg.prompt('Saving New Page As...','http://{$HTTP_HOST}/...',
		function(btn,text){
			var form_id   = Ext.getCmp('form-id').getValue();
			var form_text = Ext.getCmp('form-url').getValue();

			Ext.getCmp('form-id').setValue(null);
			Ext.getCmp('form-url').setValue(text);
			
			if(btn == 'ok'){
				if(text == ''){
					saveAs();
					alert('Please enter something or click cancel.');	
				}
				Ext.getCmp('new-form').getForm().submit({
					url		: '/{$toBackDoor}/{$Xtra}/add/?returnJson',
					success	: function(){
						page_data.getStore().load();
						Ext.getCmp('editor-win').close();
					},
					failure : function(f,a){
						Ext.Msg.alert('Failed!',a.result.error);
					}
				});
			}else{
				Ext.getCmp('form-id').setValue(form_id);
				Ext.getCmp('form-url').setValue(form_text);
			}
		}
	);
}

var getThemesStore = new Ext.data.JsonStore({  
    autoLoad: true,
	url: '/{$toBackDoor}/layout/getThemes/?returnJson',
	root: 'data', 
    fields : [{
        name: 'id'
	},{
		name: 'name'
	}]  
}); 

new_drip_form = new Ext.form.FormPanel({
	id		: 'new-drip-form',
	layout	: 'border',
	frame	: true,
	
	
	items	: [{
		region	: 'north',
		layout	: 'form',
		height	: 80,
		defaultType	: 'textfield',
		defaults	: {
			anchor	: '-10'
		},
		items	: [{
			xtype	: 'hidden',
			id		: 'drip-id',
			name	: 'id'
		},{
			xtype	: 'hidden',
			id		: 'drip-optin-id',
			name	: 'optin_id'
		},{
			fieldLabel	: 'Day to Drip',
			xtype	: 'spinnerfield',
			name	: 'day_in_chain', 
			minValue: 0,
			value	: 0,
			anchor	: '25%',
	    	maxValue: 3650 
		},new Ext.form.ComboBox({  
			fieldLabel: 'From',
			name	: 'from_address',
			id		: 'reply_from',
			vtype	: 'email',
			allowBlank: false,
		    emptyText: 'From Address',
		    store: new Ext.data.JsonStore({  
			    autoLoad: true,
		    	url: '/inbox/getMailboxes/?json',
		    	root: 'data', 
		        fields : [{
			        name: 'id'
				},{
					name: 'server_username'
				}]  
		    }),  
		    valueField	: 'id',  
		    displayField: 'server_username', 
		    mode		: 'remote',  
		    minChars 	: 0 ,
		    allowBlank	: false, 
			value		: Ext.util.Cookies.get('user[email]'),
			listeners: {
				beforeselect: function(cb,r,i){

				}
			}
		}),{
			fieldLabel	: 'Subject',
			hideLabel	: true,
			allowBlank	: false,
			emptyText	: 'Subject',
			name	: 'subject',
		}]
	},{
		hideLabel: true,
		region	: 'center',
		layout	: 'fit',
		xtype	: 'tinymce',
		name	: 'email_content',

		anchor: "-20 -50",
		tinymceSettings: {
			 theme: "advanced",
		}
	}],
	buttonAlign	: 'center',
	buttons	: [{
		text	: 'Save Email Drip',
		iconAlign: 'bottom',
		iconCls	: 'x-icon-16x16-email_link',
		handler	: function(){ 
			Ext.Msg.wait('Saving to Chain','Please Wait');
			Ext.getCmp('new-drip-form').getForm().submit({
				url	: '/{$toBackDoor}/{$Xtra}/editDrip/?returnJson',
				success	: function(){
					Ext.Msg.hide();
					auto_emails_store.reload()	
					Ext.getCmp('new-drip-win').hide();
					new_drip_form.getForm().reset();
				},
				failure	: function(){
					Ext.Msg.hide();
				}

			});
		}
	}]	
});

new_drip_win  =	new Ext.Window({
	id		: 'new-drip-win',
	modal	: true,
	title	: 'Email Drip',
	iconCls: 'x-icon-16x16-email_edit',
	layout	: 'fit',
	manager	: MyDesktop.getDesktop().getManager(),
	maximized	: true,
	closeAction	: 'hide',
	height	:  $(window).height()*.55,
	items	: [new_drip_form]
});


new_headline_win = function(){
    headline_form = new Ext.form.FormPanel({
		region	: 'center',
		id		: 'new-headline-form',
		frame	: true,
		autoHeight: true,
		layout	: 'form',
		items	: [{
			fieldLabel	: 'Headline',
			hideLabel	: true,
			name	: 'headline',
			xtype	: 'textfield',
			id		: 'new-headline-text',
			selectOnFocus: true,
			anchor	: '99%',
			enableKeyEvents: true,
			listeners	: {
				keydown : function(tf,e){
					if(e.getKey() == 13){
						Ext.Msg.wait('Please Wait...','Saving Headline')
						Ext.getCmp('new-headline-form').getForm().submit({
							url	: '/{$toBackDoor}/{$Xtra}/addHeadline/?returnJson',
							success	: function(){
								Ext.Msg.hide();
								headlines_store.load();
								//headlines.getSelectionModel().clearSelections();
								//Ext.getCmp('new-headline-form').getForm().reset();
								//tf.focus();
								Ext.getCmp('new-headline-win').hide();
							},
							failure : function(){
								Ext.Msg.hide();
							}
						});											
					}
				}
			}
		},{
			xtype	: 'hidden',
			name	: 'id'
		}/*,{
			layout	: 'column',
			defaults	: {
	    		layout		: 'form'
			},
			items	: [{
				columnWidth	: .25,
				items		: [{
					fieldLabel: 'Font',

				}]
			},{
				columnWidth	: .25,
				items		: [{
					fieldLabel: 'Size',

				}]
			},{
				columnWidth	: .25,
				items		: [{
					fieldLabel: 'Color',
				}]
			}]
		}*/]
	});
    var manager = (MyDesktop) ? MyDesktop.getDesktop().getManager() : null
	return {
		closeAction	: 'hide',
		manager	: manager,
		title	: 'Headline Editor',
		iconCls	: 'x-icon-16x16-tag_edit',
		modal	: true,
		id		: 'new-headline-win', 
		width	: '50%',
		height	: 115,
		items :	[headline_form],
		buttonAlign: 'center',
		buttons	: [{
			iconAlign	: 'bottom', 
			xtype	: 'button',
			text	: 'Delete',
			iconCls	: 'x-icon-16x16-tag_remove',
			anchor	: '-10',
			handler	: function(){
				Ext.Msg.wait('Please Wait...','Deleting Headline')
				Ext.getCmp('new-headline-form').getForm().submit({
					url	: '/{$toBackDoor}/{$Xtra}/deleteHeadline/?returnJson',
					success	: function(){
						Ext.Msg.hide();

						var grid = Ext.getCmp('headlines-grid');
						if(!grid){
							grid = Ext.getCmp('allheadlines-grid');

						}
						
						grid.getSelectionModel().clearSelections();
						
						headlines_store.load();
						Ext.getCmp('new-headline-form').getForm().reset();
						Ext.getCmp('new-headline-win').hide();
					},
					failure : function(){
						Ext.Msg.hide();
					}
				});
			}
		},{
			xtype	: 'button',
			text	: 'Cancel',
			iconCls	: 'x-icon-16x16-tag_yellow',
			iconAlign	: 'bottom',
			handler	: function(){ 
				Ext.getCmp('new-headline-win').hide();
			}
		},{
			iconAlign	: 'bottom',
			xtype	: 'button',
			text	: 'Save',
			iconCls	: 'x-icon-16x16-tag_add',
			anchor	: '99%',
			handler	: function(){
				Ext.Msg.wait('Please Wait...','Saving Headline')
				Ext.getCmp('new-headline-form').getForm().submit({
					url	: '/{$toBackDoor}/{$Xtra}/addHeadline/?returnJson',
					success	: function(){
						Ext.Msg.hide();
						headlines_store.load();
						Ext.getCmp('new-headline-win').hide();
					},
					failure : function(){
						Ext.Msg.hide();
					}
				});
			}
		}]
	}
	
}();

var win = new Ext.Window(new_headline_win);
win.show();
win.hide();

/**
 * Template for Dataview
 */
var template = new Ext.XTemplate(
		'<tpl for=".">',
		'<div class="magnet-wrap" id="{literal}node_{id}{/literal}">',
			'<div class="magnet">',
				'<div class="title"> {literal}{url}{/literal} </div>', 
				'<div class="north pole">','</div>',
				
				'<div class="whitespace" >',
					'<button onclick="window.open(\'/{literal}{url}{/literal}\')" style="padding: 5px;">',
					'<img src="{$ICON.16}/world.png" title="Visit" align="absmiddle"/> Visit',
				'</button>',
				'<button onclick="xMagnet.openContent(this,{literal}{id}{/literal},\'{literal}{url}{/literal}\')" style="padding: 5px; ">',
				'<img src="{$ICON.16}/page_edit.png" title="Edit" align="absmiddle"/> Edit',
			'</button>',
				'<button onclick="xMagnet.copyContent({literal}{id}{/literal},\'{literal}{url}_copy{/literal}\')" style="padding: 5px;  ">',
					'<img src="{$ICON.16}/page_copy.png" title="Copy This" align="absmiddle"/> Copy',
					'</button> ',
					
					
					'<button class="del-button" onclick="xMagnet.deleteMagnet({literal}{id}{/literal},\'{literal}{url}{/literal}\')" style="padding: 5px; display: none">',
					'<img src="{$ICON.16}/remove.png" title="Delete" align="absmiddle"/> Delete',
				'</button>',
					
				'</div>', 
				'<div class="south pole">{literal}{conversions}{/literal}</div>',
				
				
				
			'</div>', 
		{foreach from=$nodes item=node}
		{if $node == 'img'}
			'<img src="{literal}{{/literal}{$node}{literal}}{/literal}" class="thumb-img">',
		{else if $node == 'url'}

		{else}
			'<div class="thumb-div-{$node}">{literal}{{/literal}{$node}{literal}}{/literal}</div>',
		{/if}
		{/foreach}
		'</div>',
		'</tpl>'
	);



/**
 * Dataview
 */
{include 
	file="~extjs/dataview.js" 
	var="page_data" 
	template="template"
	root="data"
	url="jsonPages" 
		itemSelector="div.magnet-wrap"
	fields=$fields}

page_data.getStore().addListener('load',function(){
	$('#magnet-count').html($('.thumb-wrap').length);
});

/**
 * File Dataview
 */

 /**
  * Template for Dataview
  */
  {include 
		file="~extjs/template.js" 
		var="file_template"
		tmp="file"
		nodes=$file_nodes}

	

	headlines_store = new Ext.data.JsonStore({
        url		: "/{$toBackDoor}/{$Xtra}/jsonHeadlines/?json",
        method	: 'POST',
        root	: 'data',
        idProperty	: 'id',
        autoLoad: true,
        fields	: {$headlines_fields},
        listeners	: {
	        load	: function(s,r,o){
				var page_views = 0;
				var conversions = 0;
				var add = 0;
				for(i in r){

					if(r[i].data){
					
					add = r[i].data.page_views; 
					
					page_views = Math.floor(add + page_views);

					add = r[i].data.conversions;
					
					conversions = Math.floor(add + conversions);
					}
					//page_views 	= page_views + Math.floor(r[i].data.page_views);
					//conversions = conversions + Math.floor(r[i].data.conversions);
				}
     			$('#view-count').html(page_views);
     			$('#user-count').html(conversions);

     			var rate = Math.floor(100 / (page_views / conversions)); 
     			$('#conversion-rate').html( rate+'%');
				
     			
	        }
	    }
    });
	
	var optin_panel = new Ext.Panel({ 
		title	: 'Magnets',
		iconCls	: 'x-icon-16x16-magnet_pencil',
		iconScale	: 'large',
		id		: 'data-view-panel',
		layout	: 'fit',
		region	: 'center',
		plain	: true,
		items	: page_data
	});

	page_data.getStore().load();

	x4.Window({
		title	: 'Lead Magnet&#0153; Generator',
		id		: 'lead-magnet',
		iconCls	: 'x-icon-16x16-magnet_blue',
		layout	: 'border',
		maximized : true,
		plain	: true,
		defaults	: {
			border	: false
		},
		items	: [optin_panel,{
			region	: 'north',
			layout	: 'form',
			buttonAlign	: 'left',
			buttons	: [{
				text	: 'New Magnet',
				iconCls	: 'x-icon-16x16-magnet_plus',
				tooltip	: { title : 'New Magnet', text: 'Click to Create a <b>New Lead Magnet</b>'},
				iconAlign : 'top',
				handler	: function(){
					xMagnet.newMagnetWin().show(null,function(){
						setTimeout(function(){
							Ext.getCmp('{$ME}-new-magnet-url').focus();
						},1000);
					});
			    }
			},'-',{
				text	: 'All Headlines',
				tooltip	: { title : 'All Headlines', text: 'Click to View All Headlines from <b>ALL Lead Magnets</b>'},
				iconCls	: 'x-icon-16x16-tag_blue',
				iconAlign : 'top',
				handler	: xMagnet.allHeadlines				
			},'-',{
				text	: 'Show Delete',
				tooltip	: { title : 'Show Delete', text: 'Toggles Display of Button to Delete <b>a Lead Magnet</b> '},
				iconCls	: 'x-icon-16x16-magnet_minus',
				iconAlign : 'top',
				handler	: function(){
					$('.del-button').toggle()
				}
			},'->','<img src="{$ICON.16}/world.png" align="absmiddle" title="Total Magnets" /> Magnets: <span id="magnet-count"></span>','-',
	   		'<img src="{$ICON.16}/eye.png" align="absmiddle"  title="Total Views" /> Views: <span id="view-count">{$count_page_views}</span> ','-',
	   		'<img src="{$ICON.16}/user.png" align="absmiddle" title="Total Conversions" /> Conversions: <span id="user-count">{$count_conversions}</span> ','-',
	   		'<img src="{$ICON.16}/thumb_up.png" align="absmiddle" title="Total Conversion Rate" /> Total Rate: <span id="conversion-rate"></span>']
		}]
	}).show();	
	
	/*
	.show(null,function(win){
		win.setHeight($(document.body).height()-$('#neck-breadcrumbs').outerHeight()-$('#moonmenu').outerHeight());
		page_data.getStore().load();
	});
	*/

		
	
	

});

/**
 * Create a DragZone instance for our JsonView
 */
ImageDragZone = function(view, config){
    this.view = view;
    ImageDragZone.superclass.constructor.call(this, view.getEl(), config);
};
Ext.extend(ImageDragZone, Ext.dd.DragZone, {
    // We don't want to register our image elements, so let's 
    // override the default registry lookup to fetch the image 
    // from the event instead
    getDragData : function(e){
        var target = e.getTarget('.thumb-wrap');
        if(target){
            var view = this.view;
            if(!view.isSelected(target)){
                view.onClick(e);
            }
            var selNodes = view.getSelectedNodes();
            var dragData = {
                nodes: selNodes
            };
            if(selNodes.length == 1){
                dragData.ddel = target;
                dragData.single = true;
            }else{
                var div = document.createElement('div'); // create the multi element drag "ghost"
                div.className = 'multi-proxy';
                for(var i = 0, len = selNodes.length; i < len; i++){
                    div.appendChild(selNodes[i].firstChild.firstChild.cloneNode(true)); // image nodes only
                    if((i+1) % 3 == 0){
                        div.appendChild(document.createElement('br'));
                    }
                }
                var count = document.createElement('div'); // selected image count
                count.innerHTML = i + ' images selected';
                div.appendChild(count);
                
                dragData.ddel = div;
                dragData.multi = true;
            }
            return dragData;
        }
        return false;
    },

    // this method is called by the TreeDropZone after a node drop
    // to get the new tree node (there are also other way, but this is easiest)
    getTreeNode : function(drag,drop){
    	var nodeData = this.view.getRecords(this.dragData.nodes);
    	var items = Ext.util.Format.plural(nodeData.length,'Item')
		DROP = drop;
    	/*if(drop.dir == 'undefined'){
			drop = drop.parentNode;
		}*/
    	var con = confirm('Moving '+items+' to '+drop.text);
    	
		if(con){
	        Ext.MessageBox.show({
	            title: 'Moving Items',
	            msg: 'Moving Items to '+drop.text+'...',
	            progressText: 'Moving...',
	            width:300,
	            progress:true,
	            closable:false,
	            animEl: drop.id
	        });

	        // this hideous block creates the bogus progress
	        var f = function(v){
	             return function(){
	                 
	            };
	        };
	        view.store.remove(nodeData);
	        for(var i = 0, len = nodeData.length; i < len; i++){
	            var data = nodeData[i].data;

	            $.post('/{$toBackDoor}/upload/dropFile/?returnJson',{
		            data: data.id,
		            drop: drop.id.replace('dir-','')
		        },function(r){
		    		if(i == nodeData.length){
     					//var tab = Ext.getCmp('infinite-tabs').getActiveTab();
     			    	//var browse = tab.getId().replace('infinite-tab-','');
     			    	//var view = ume.webgrams.infinite.browsers['infinite-uploadify-'+browse]
     			    	                                         
						//view.store.load();
     			    	
     			    	Ext.Msg.alert('Move Complete', 'Your items are now in '+drop.text);
     			    	Ext.MessageBox.hide();
					}	
		    	});
	         	// Save the items to the new location.
		    		
		    	var x = i/nodeData.length;
				Ext.MessageBox.updateProgress(x, Math.round(100*x)+'% completed');
	        }

			
		}
		
		var treeNodes = [];
        
        
        return false;
    },
    
    // the default action is to "highlight" after a bad drop
    // but since an image can't be highlighted, let's frame it 
    afterRepair:function(){
        for(var i = 0, len = this.dragData.nodes.length; i < len; i++){
            Ext.fly(this.dragData.nodes[i]).frame('#8db2e3', 1);
        }
        this.dragging = false;    
    },
    
    // override the default repairXY with one offset for the margins and padding
    getRepairXY : function(e){
        if(!this.dragData.multi){
            var xy = Ext.Element.fly(this.dragData.ddel).getXY();
            xy[0]+=3;xy[1]+=3;
            return xy;
        }
        return false;
    }
});
//openContent(null,null,null,true);
--></script>
{include file="/{$toBackDoor}/{$Xtra}/help.html"}
<!--<script type="text/javascript" src="/bin/js/jq/tiny_mce/jquery.tinymce.js"></script>
<script>
function renderTiny() {
	$('textarea.tinymce').tinymce({
		// Location of TinyMCE script
		script_url : '/bin/js/jq/tiny_mce/tiny_mce.js',
		
		// General options
		theme : "advanced",
    skin : "o2k7",
    skin_variant : "silver",

		plugins : "pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template,advlist",

		// Theme options
		// Options
		theme_advanced_buttons1 : "newdocument,template,fullscreen,|,undo,redo,|,search,replace,|,cut,copy,paste,pastetext,pasteword,|,inserttime,insertdate,|,preview,print",
		
		// Elements
		theme_advanced_buttons2 : "image,media,anchor,|,link,unlink,|,advhr,hr,|,bullist,numlist,|,outdent,indent,blockquote,sub,sup,|,attribs,code,|,cleanup,iespell",

		// Layout 
		theme_advanced_buttons3 : "charmap,pagebreak,nonbreaking,|,visualchars,visualaid,|,tablecontrols,|,insertlayer,moveforward,movebackward,absolute",
		

		// Font - styleselect,
		theme_advanced_buttons4 : "removeformat,styleprops,formatselect,fontselect,fontsizeselect,forecolor,backcolor,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,ltr,rtl",

		theme_advanced_toolbar_location : "top",
		theme_advanced_toolbar_align : "left",
		theme_advanced_statusbar_location : "bottom",
		theme_advanced_resizing : true,

		// Example content CSS (should be your site CSS)
		//content_css : "css/content.css",
		
		// Drop lists for link/image/media/template dialogs
		//template_external_list_url : "lists/template_list.js",
		//external_link_list_url : "lists/link_list.js",
		//external_image_list_url : "lists/image_list.js",
		//media_external_list_url : "lists/media_list.js",
	});

	setTimeout(function(){
		var jar = $('.mceIframeContainer iframe');
		var con = jar.parent().parent().parent().parent().parent().parent(); 
		jar.width(con.innerWidth()-2);
		jar.height(con.innerHeight()-130);
		Ext.Msg.hide();	
	},5000);
}
</script>-->